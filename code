%CONST MESSAGETHRESHOLD, 10
%CONST INITVANMOVEDELAY, 5
%CONST MAXPASSENGERS, 5
%CONST INITPRICEPERVERTEX, 2

MESSAGE VanBelongsToCompany,Request
PRM companyEnum,float
EMESSAGE

MESSAGE VanBelongsToCompanyResponse,Request
PRM belongs,float
EMESSAGE

MESSAGE VanIsAvailable,Request
PRM destinationLine, float
PRM destinationVertex,float
PRM locationVertex,float
PRM locationLine, float
EMESSAGE

MESSAGE VanIsAvailableResponse,Inform
PRM available,float
EMESSAGE

MESSAGE VanFree, Inform
EMESSAGE

MESSAGE VanFull, Inform
EMESSAGE

MESSAGE PassengerRequest, Request
PRM destinationLine, float
PRM destinationVertex, float
PRM locationVertex, float
PRM locationLine, float
EMESSAGE

MESSAGE PassengerRequestResponse,Inform
PRM accepted, float
PRM vanId, float # TODO: later jid
PRM price, float
PRM distance, float
PRM travelTime, float
PRM score, float
EMESSAGE

MESSAGE PassengerBookVan, Request
PRM destinationLine, float
PRM destinationVertex, float
PRM locationVertex, float
PRM locationLine, float
EMESSAGE

MESSAGE PassengerBookVanResponse, Inform
PRM accepted, float
EMESSAGE

MESSAGE SendConfirmationToVan, Inform
EMESSAGE

MESSAGE SendRefusalToVan, Inform
EMESSAGE

MESSAGE AcceptNewPassenger, Request
PRM additionalTime, float
PRM reducedPrice, float
EMESSAGE

MESSAGE SendConfirmationToVanAboutNewPassenger, Inform
EMESSAGE

MESSAGE SendRefusalToVanAboutNewPassenger, Inform
EMESSAGE

# MESSAGE PassengerChooseVan, Inform
# PRM destinationVertex,float
# PRM locationVertex,float
# EMESSAGE

MESSAGE LineBelongsToVan,Request
EMESSAGE

MESSAGE VanGotToDestination, Inform
PRM earning,float
PRM passengersTravelled, float
EMESSAGE

MESSAGE PassengerAtDestination, Inform
PRM atDestination, float
PRM score, float
PRM pricePaid, float
EMESSAGE

MESSAGE MoveVanNewPassengerLocation, Inform
PRM locationVertex,float
PRM locationLine,float
EMESSAGE


AGENT CompanyAgent
PRM companyId, float, dist, uniform, 0, 10
PRM earningRate, float, init, 0
PRM vanList, list, conn
PRM availableVanList, list, conn
PRM companyEnum, enum, C1, 20, C2, 20, C3, 20, C4, 20, C5, 20
PRM companyEnumFloat, float, init, 0
PRM messageReceivedCount, float, init, 0
PRM messageReceivedCountThreshold, float, init, MESSAGETHRESHOLD
PRM sendMessageToPassengerFlag, float, init, 0

BEHAV VanBelongsToCompanySetup, setup
ACTION ConvertEnumToFloat, modify_self
IEQ companyEnum,C1
SET companyEnumFloat,1
EBLOCK
IEQ companyEnum,C2
SET companyEnumFloat,2
EBLOCK
IEQ companyEnum,C3
SET companyEnumFloat,3
EBLOCK
IEQ companyEnum,C4
SET companyEnumFloat,4
EBLOCK
IEQ companyEnum,C5
SET companyEnumFloat,5
EBLOCK
EACTION
ACTION VanBelongsToCompanyAction,send_msg,VanBelongsToCompany,Request
SET SEND.companyEnum,companyEnumFloat
SEND connections
EACTION
EBEHAV

BEHAV OnVanBelongsToCompanyResponse,msg_rcv,VanBelongsToCompanyResponse,Request
ACTION AddVanToList,modify_self
IEQ RCV.belongs,1
ADDE vanList,RCV.sender
EBLOCK
EACTION
EBEHAV

#----------------------------------------------------------------------------------------------
# we will do it in a different way, so the code below probably could be deleted
BEHAV OnPassengerRequest,msg_rcv,PassengerRequest,Request
ACTION VanIsAvailableAction,send_msg,VanIsAvailable,Request
SET SEND.destinationVertex,RCV.destinationVertex
SET SEND.destinationLine,RCV.destinationLine
SET SEND.locationVertex,RCV.locationVertex
SET SEND.locationLine,RCV.locationLine
SEND vanList
EACTION
ACTION SendResponseToPassenger, send_msg, PassengerRequestResponse, Inform
SET SEND.accepted,1 
WEQ sendMessageToPassengerFlag,0
IGTEQ messageReceivedCount, messageReceivedCountThreshold
SET sendMessageToPassengerFlag,1
#TODO: add availableVanList to message body
SEND RCV.sender
EBLOCK
EBLOCK
EACTION
ACTION ResetFlag, modify_self
SET sendMessageToPassengerFlag,0
EACTION
EBEHAV

BEHAV OnVanIsAvailableRespone,msg_rcv,VanIsAvailableResponse,Inform
ACTION AddAvailableVanToList,modify_self
IEQ RCV.available,1
ADD messageReceivedCount,1
ADDE availableVanList,RCV.sender
EBLOCK
EACTION
EBEHAV
#----------------------------------------------------------------------------------------------

BEHAV OnVanIsFree, msg_rcv, VanFree, Inform
ACTION AddVanToList, modify_self
ADDE availableVanList, RCV.sender
EACTION
EBEHAV

BEHAV OnVanIsFull, msg_rcv, VanFull, Inform
ACTION DeleteVanFromList, modify_self
DECL counter, float, 0
DECL listElement, conn, "test"
DECL listLength, float, 0
LEN listLength, availableVanList
WNEQ counter, listLength
LR listElement, availableVanList, counter
IEQ listElement, RCV.sender
REME availableVanList, listElement
EBLOCK
ADD counter, 1
EBLOCK
EACTION
EBEHAV

BEHAV OnPassengerRequest, msg_rcv, PassengerRequest, Request
ACTION SendResponseToPassenger, send_msg, PassengerRequestResponse, Inform
DECL listLength, float, 0
DECL listElement, conn, "test"
DECL randomNumber, float, 0
LEN listLength, availableVanList

IEQ listLength, 0
SET SEND.accepted, 0
SET SEND.vanId, 0
SET SEND.price, 0
SET SEND.distance, 0
SET SEND.travelTime, 0
SET SEND.score, 0
EBLOCK

IGT listLength, 0
RAND randomNumber, int, uniform, 0, listLength
LR listElement, availableVanList, randomNumber
SET SEND.accepted, 1
SET SEND.vanId, listElement
SET SEND.price, 1 # TODO: change parameters to real ones
SET SEND.distance, 1 # TODO: change parameters to real ones
SET SEND.travelTime, 1 # TODO: change parameters to real ones
SET SEND.score, 1 # TODO: change parameters to real ones
EBLOCK

EACTION
EBEHAV





BEHAV OnVanGotToDestination, msg_rcv, VanGotToDestination, Inform
ACTION ModifyEarningRate, modify_self
decl newEarningRate,float,RCV.earning
DIV newEarningRate,RCV.passengersTravelled
IGT newEarningRate, earningRate
SET earningRate, newEarningRate
EBLOCK
EACTION
EBEHAV

EAGENT




AGENT VanAgent
PRM companyEnum,enum,C1,20,C2,20,C3,20,C4,20,C5,20
PRM companyEnumFloat,float,init,0
PRM companyList,list,conn

PRM score,float,init,10
PRM type,enum,Basic,50,Premium,50
PRM minimalPrice,float,init,0

PRM locationVertex,float,init,0  #TODO: SHOULD BE UNIFORM DIST
PRM locationLine, enum, L0,25, L1,25, L2,25, L3,25
PRM locationLineFloat, float, init, 0
PRM destinationLineFloat, float, init, 0
PRM linesList, list, conn
PRM distanceThreshold,float,init,10 #TODO: SHOULD BE UNIFORM DIST
PRM currentDestinationVertex,float, init,0
PRM currentDestinationLineFloat,float, init,0

PRM vanMoveDelay,float, init,INITVANMOVEDELAY
PRM carriedPassengers,list,conn
PRM maxPassengers, float, init, MAXPASSENGERS
PRM travellingFlag,float,init,0


PRM pricePerVertex,float, init, INITPRICEPERVERTEX

BEHAV VanSetup, setup
ACTION ConvertEnumToFloat, modify_self
IEQ locationLine, L0
SET locationLineFloat, 0
EBLOCK
IEQ locationLine, L1
SET locationLineFloat, 1
EBLOCK
IEQ locationLine, L2
SET locationLineFloat, 2
EBLOCK
IEQ locationLine, L3
SET locationLineFloat, 3
EBLOCK
EACTION
EBEHAV

BEHAV VanBelongsToCompanySetup,msg_rcv,VanBelongsToCompany,Request
ACTION ConvertEnumToFloat,modify_self
IEQ companyEnum,C1
SET companyEnumFloat,1
EBLOCK
IEQ companyEnum,C2
SET companyEnumFloat,2
EBLOCK
IEQ companyEnum,C3
SET companyEnumFloat,3
EBLOCK
IEQ companyEnum,C4
SET companyEnumFloat,4
EBLOCK
IEQ companyEnum,C5
SET companyEnumFloat,5
EBLOCK
EACTION
ACTION SendResponse,send_msg,VanBelongsToCompanyResponse,Request
IEQ RCV.companyEnum,companyEnumFloat
SET SEND.belongs,1
ADDE companyList,RCV.sender
EBLOCK
INEQ RCV.companyEnum,companyEnumFloat
SET SEND.belongs,0
EBLOCK
SEND RCV.sender
EACTION
EBEHAV

BEHAV LineBelongsToVanSetup, msg_rcv, LineBelongsToVan, Request
ACTION LineBelongsToVanAction, modify_self
ADDE linesList, RCV.sender
EACTION
EBEHAV

#-----------------------------------------------------------------------------------------------------
BEHAV OnVanIsAvailable,msg_rcv,VanIsAvailable,Request
ACTION VanIsAvailableAction,send_msg,VanIsAvailableResponse,Inform
decl distanceFromDestination, float, 0
ADD distanceFromDestination, RCV.destinationVertex
SUBT distanceFromDestination, locationVertex
SET SEND.available,0
ILTEQ distanceFromDestination, distanceThreshold
SET distanceFromDestination,0
ADD distanceFromDestination, RCV.locationVertex
SUBT distanceFromDestination, locationVertex
ILTEQ distanceFromDestination, distanceThreshold
SET SEND.available,1
EBLOCK
EBLOCK
SEND RCV.sender
EACTION
EBEHAV
#-----------------------------------------------------------------------------------------------------

BEHAV MoveVan, cyclic, INITVANMOVEDELAY
ACTION ChangeVanLocationVertex, modify_self
IGT currentDestinationVertex, locationVertex
ADD locationVertex,1
EBLOCK
ILT currentDestinationVertex,locationVertex
SUBT locationVertex,1
EBLOCK
EACTION
EBEHAV

#-----------------------------------------------------------------------------------------------------
BEHAV OnPassengerChooseVan, msg_rcv, PassengerChooseVan, Inform
ACTION PassengerChoseMe, modify_self
IGT RCV.destinationVertex, currentDestinationVertex
SET currentDestinationVertex,RCV.destinationVertex
EBLOCK
ADDE carriedPassengers,RCV.sender
EACTION
EBEHAV
EAGENT
#-----------------------------------------------------------------------------------------------------

AGENT PassengerAgent
PRM locationLine, enum, L0,25, L1,25, L2,25, L3,25
PRM locationLineFloat, float, init, 0
PRM locationVertex, float, dist, uniform, 0, 50 #TODO: must be int here

PRM destinationLine, enum, L0,25, L1,25, L2,25, L3,25
PRM destinationLineFloat, float, init, 0 #TODO: must be int here
PRM destinationVertex, float, dist, uniform, 0, 50

PRM pricePreference, float, init, 0 #TODO: unifrom dist
PRM scorePreference, float, init, 0 #TODO: unifrom dist

PRM isTravelling, float, init,0
PRM availableVan, list, conn

PRM randomDecider, float, dist, uniform, 0, 1 #TODO: must be int

BEHAV PassengerSetup, setup
ACTION ConvertEnumToFloat, modify_self
IEQ locationLine, L0
SET locationLineFloat, 0
EBLOCK
IEQ locationLine, L1
SET locationLineFloat, 1
EBLOCK
IEQ locationLine, L2
SET locationLineFloat, 2
EBLOCK
IEQ locationLine, L3
SET locationLineFloat, 3
EBLOCK

IEQ destinationLine, L0
SET destinationLineFloat, 0
EBLOCK
IEQ destinationLine, L1
SET destinationLineFloat, 1
EBLOCK
IEQ destinationLine, L2
SET destinationLineFloat, 2
EBLOCK
IEQ destinationLine, L3
SET destinationLineFloat, 3
EBLOCK
EACTION

ACTION SendMessageToAll, send_msg, PassengerRequest, Request
SET SEND.destinationLine, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLine, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
EACTION
EBEHAV

BEHAV OnOfferFromCompanyReceive, msg_rcv, PassengerRequestResponse, Inform
ACTION SendMessageToVan, send_msg, PassengerBookVan, Request
DECL acceptFlag, float, 0
DECL pricePerVertex, float, 0
IEQ RCV.accepted, 1
SET pricePerVertex, RCV.price
DIV pricePerVertex, RCV.distance
IGTEQ RCV.score, 3
SET acceptFlag, 1
EBLOCK
ILTEQ pricePerVertex, 1
SET acceptFlag, 1
EBLOCK
IEQ acceptFlag, 1
ADDE availableVan, RCV.vanId
SET SEND.destinationLine, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLine, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND availableVan
EBLOCK
EBLOCK
EACTION

ACTION SendMessageToAll, send_msg, PassengerRequest, Request
IEQ RCV.accepted, 0
SET SEND.destinationLine, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLine, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
EBLOCK
EACTION
EBEHAV

BEHAV OnOfferFromVanReceive, msg_rcv, PassengerBookVanResponse, Inform
ACTION SendConfirmation, send_msg, SendConfirmationToVan, Inform
IEQ RCV.accepted, 1
IGTEQ randomDecider, 0.5
send RCV.sender
EBLOCK
EBLOCK
EACTION

ACTION SendRefusal, send_msg, SendRefusalToVan, Inform
IEQ RCV.accepted, 1
ILT randomDecider, 0.5
send RCV.sender
EBLOCK
EBLOCK
EACTION

ACTION SendMessageToAll, send_msg, PassengerRequest, Request
IEQ RCV.accepted, 0
SET SEND.destinationLine, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLine, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
EBLOCK
EACTION
EBEHAV


BEHAV OnMoveVanNewPassengerLocation, msg_rcv, MoveVanNewPassengerLocation, Inform
ACTION ChangeLocation, modify_self
SET locationLineFloat, RCV.locationLine
SET locationVertex, RCV.locationVertex
EACTION

ACTION CheckIfAtDestination, send_msg, PassengerAtDestination, Inform
IEQ locationLineFloat, destinationLineFloat
IEQ locationVertex, destinationVertex
SET SEND.atDestination, 0
SET SEND.score, 0
SET SEND.pricePaid, 0
## TODO: Increase price per move, VanAgent needs to send to PassengerAgent price per move, then it needs to be stored in PassengerAgent and added here
EBLOCK
EBLOCK
SEND RCV.sender
EACTION
EBEHAV

BEHAV OnAcceptNewPassenger, msg_rcv, AcceptNewPassenger, Inform
ACTION SendConfirmation, send_msg, SendConfirmationToVanAboutNewPassenger, Inform
DECL decider, flaot, 0
SET decider, RCV.additionalTime
DIV decider, RCV.reducedPrice
ILTEQ decider, 1 #TODO: maybe we can randomize it in the future
SEND RCV.sender
EBLOCK
EACTION

ACTION SendRefusal, send_msg, SendRefusalToVanAboutNewPassenger, Inform
DECL decider, flaot, 0
SET decider, RCV.additionalTime
DIV decider, RCV.reducedPrice
IGT decider, 1 #TODO: maybe we can randomize it in the future
SEND RCV.sender
EBLOCK
EACTION
EBEHAV
EAGENT




