%CONST MESSAGETHRESHOLD, 10
%CONST MOVEINTERVAL, 5
%CONST MAXPASSENGERS, 5
%CONST INITPRICEPERVERTEX, 2
%CONST CYCLICCHECK, 1
%CONST LINELENGTH, 49
%CONST ACCEPTNEWPASSENGERTHRESHOLD, 0.8

MESSAGE VanBelongsToCompany, Request
PRM companyEnum, float
EMESSAGE

MESSAGE VanBelongsToCompanyResponse, Request
PRM belongs, float
EMESSAGE

# MESSAGE VanIsAvailable, Request
# PRM destinationLine, float
# PRM destinationVertex, float
# PRM locationVertex, float
# PRM locationLine, float
# EMESSAGE

# MESSAGE VanIsAvailableResponse, Inform
# PRM available, float
# EMESSAGE

# MESSAGE VanFree, Inform
# EMESSAGE

MESSAGE VanFull, Inform
EMESSAGE

MESSAGE VanEmpty, Inform
EMESSAGE

MESSAGE PassengerRequest, Request
PRM destinationLineFloat, float
PRM destinationVertex, float
PRM locationVertex, float
PRM locationLineFloat, float
EMESSAGE

MESSAGE PassengerRequestResponse, Inform
PRM accepted, float
PRM vanId, conn
EMESSAGE

MESSAGE PassengerBookVan, Request
PRM destinationLineFloat, float
PRM destinationVertex, float
PRM locationVertex, float
PRM locationLineFloat, float
EMESSAGE

MESSAGE PassengerBookVanResponse, Inform
PRM accepted, float
PRM price, float
PRM distance, float
PRM travelTime, float
PRM score, float
EMESSAGE

MESSAGE SendConfirmationToVan, Inform
PRM destinationLineFloat, float
PRM destinationVertex, float
PRM locationVertex, float
PRM locationLineFloat, float
EMESSAGE

MESSAGE SendRefusalToVan, Inform
EMESSAGE

MESSAGE AcceptNewPassenger, Request
# PRM additionalTime, float
# PRM reducedPrice, float
EMESSAGE

MESSAGE SendConfirmationToVanAboutNewPassenger, Inform
EMESSAGE

MESSAGE SendRefusalToVanAboutNewPassenger, Inform
EMESSAGE

# MESSAGE PassengerChooseVan, Inform
# PRM destinationVertex, float
# PRM locationVertex, float
# EMESSAGE

MESSAGE LineBelongsToVan, Request
EMESSAGE

MESSAGE VanGotToDestination, Inform
PRM earning, float
PRM passengersTravelled, float
EMESSAGE

MESSAGE PassengerAtDestination, Inform
# PRM atDestination, float
PRM score, float
# PRM pricePaid, float
EMESSAGE

MESSAGE MoveVanNewPassengerLocation, Inform
PRM locationVertex, float
PRM locationLineFloat, float
EMESSAGE

MESSAGE SendIntersectionPoint, Inform
PRM line, float
PRM vertex, float
EMESSAGE

MESSAGE RequestIntersectionPoint, Request
PRM locationLineFloat, float
PRM locationVertex, float
PRM destinationLineFloat, float
EMESSAGE


AGENT CompanyAgent
PRM companyId, float, dist, uniform, 0, 10
PRM companyEnum, enum, C1, 20, C2, 20, C3, 20, C4, 20, C5, 20
PRM companyEnumFloat, float, init, 0

PRM vanList, list, conn
PRM availableVanList, list, conn

PRM earningRate, float, init, 0

PRM messageReceivedCount, float, init, 0
PRM messageReceivedCountThreshold, float, init, MESSAGETHRESHOLD
PRM sendMessageToPassengerFlag, float, init, 0

BEHAV VanBelongsToCompanySetup, setup
ACTION ConvertEnumToFloat, modify_self
IEQ companyEnum, C1
SET companyEnumFloat, 1
EBLOCK
IEQ companyEnum, C2
SET companyEnumFloat, 2
EBLOCK
IEQ companyEnum, C3
SET companyEnumFloat, 3
EBLOCK
IEQ companyEnum, C4
SET companyEnumFloat, 4
EBLOCK
IEQ companyEnum, C5
SET companyEnumFloat, 5
EBLOCK
EACTION
ACTION VanBelongsToCompanyAction, send_msg, VanBelongsToCompany, Request
SET SEND.companyEnum, companyEnumFloat
SEND connections
EACTION
EBEHAV

BEHAV OnVanBelongsToCompanyResponse, msg_rcv, VanBelongsToCompanyResponse, Request
ACTION AddVanToList, modify_self
IEQ RCV.belongs, 1
ADDE vanList, RCV.sender
ADDE availableVanList, RCV.sender
EBLOCK
EACTION
EBEHAV

#----------------------------------------------------------------------------------------------
# we will do it in a different way, so the code below probably could be deleted
# BEHAV OnPassengerRequest, msg_rcv, PassengerRequest, Request
# ACTION VanIsAvailableAction, send_msg, VanIsAvailable, Request
# SET SEND.destinationVertex, RCV.destinationVertex
# SET SEND.destinationLine, RCV.destinationLine
# SET SEND.locationVertex, RCV.locationVertex
# SET SEND.locationLine, RCV.locationLine
# SEND vanList
# EACTION
# ACTION SendResponseToPassenger, send_msg, PassengerRequestResponse, Inform
# SET SEND.accepted, 1 
# WEQ sendMessageToPassengerFlag, 0
# IGTEQ messageReceivedCount, messageReceivedCountThreshold
# SET sendMessageToPassengerFlag, 1
#TODO: add availableVanList to message body
# SEND RCV.sender
# EBLOCK
# EBLOCK
# EACTION
# ACTION ResetFlag, modify_self
# SET sendMessageToPassengerFlag, 0
# EACTION
# EBEHAV

# BEHAV OnVanIsAvailableRespone, msg_rcv, VanIsAvailableResponse, Inform
# ACTION AddAvailableVanToList, modify_self
# IEQ RCV.available, 1
# ADD messageReceivedCount, 1
# ADDE availableVanList, RCV.sender
# EBLOCK
# EACTION
# EBEHAV

# BEHAV OnVanIsFree, msg_rcv, VanFree, Inform
# ACTION AddVanToList, modify_self
# ADDE availableVanList, RCV.sender
# EACTION
# EBEHAV
#----------------------------------------------------------------------------------------------

BEHAV OnVanIsFull, msg_rcv, VanFull, Inform
ACTION DeleteVanFromList, modify_self
IN availableVanList, RCV.sender
REME availableVanList, RCV.sender
EBLOCK
EACTION
EBEHAV

BEHAV OnVanIsEmpty, msg_rcv, VanEmpty, Inform
ACTION DeleteVanFromList, modify_self
NIN availableVanList, RCV.sender
ADDE availableVanList, RCV.sender
EBLOCK
EACTION
EBEHAV

BEHAV OnPassengerRequest, msg_rcv, PassengerRequest, Request
ACTION SendResponseToPassenger, send_msg, PassengerRequestResponse, Inform
DECL listLength, float, 0
DECL listElement, conn, "test"
DECL randomNumber, float, 0
LEN listLength, availableVanList

IEQ listLength, 0
SET SEND.accepted, 0
SET SEND.vanId, "test"
EBLOCK

IGT listLength, 0
RAND randomNumber, int, uniform, 0, listLength
LR listElement, availableVanList, randomNumber
SET SEND.accepted, 1
SET SEND.vanId, listElement
EBLOCK
EACTION
EBEHAV

BEHAV OnVanGotToDestination, msg_rcv, VanGotToDestination, Inform
ACTION ModifyEarningRate, modify_self
DECL newEarningRate, float, RCV.earning
DIV newEarningRate, RCV.passengersTravelled
IGT newEarningRate, earningRate
SET earningRate, newEarningRate
EBLOCK
EACTION
EBEHAV
EAGENT




AGENT VanAgent
PRM companyEnum, enum, C1, 20, C2, 20, C3, 20, C4, 20, C5, 20
PRM companyEnumFloat, float, init, 0
PRM companyList, list, conn
PRM linesList, list, conn

PRM score, float, init, 5
# PRM type, enum, Basic, 50, Premium, 50 - #TODO: MAYBE ADD IN THE FUTURE
# PRM minimalPrice, float, init, 0 #TODO

PRM locationLine, enum, L0, 25, L1, 25, L2, 25, L3, 25
PRM locationLineFloat, float, init, 0
PRM locationVertex, float, init, 0

# PRM destinationLineFloat, float, init, 0
# PRM distanceThreshold, float, init, 10 #TODO: SHOULD BE UNIFORM DIST
PRM currentDestinationVertex, float, init, 0
PRM currentDestinationLineFloat, float, init, 0
PRM intersectionVertex, float, init, 0
# PRM afterIntersectionVertex, float, init, 0
PRM afterIntersectionLineFloat, float, init, 0

# PRM vanMoveDelay, float, init, MOVEINTERVAL
PRM carriedPassengers, list, conn
PRM maxPassengers, float, init, MAXPASSENGERS
PRM isTravelling, float, init, 0
PRM pricePerVertex, float, init, 0

PRM sumOfScores, float, init, 0 #TODO
PRM sumOfTrips, float, init, 0 #TODO
PRM askForIntersectionFlag, float, init, 0
PRM listOfPassengersDestinationsLines, list, float
PRM listOfPassengersDestinationsVertices, list, float

BEHAV OnVanSetup, setup
ACTION GenerateParameters, modify_self
RAND locationVertex, int, uniform, 0, LINELENGTH
RAND pricePerVertex, float, uniform, 0, 1
SET isTravelling, 1
EACTION

ACTION ConvertEnumToFloat, modify_self
IEQ locationLine, L0
SET locationLineFloat, 0
EBLOCK
IEQ locationLine, L1
SET locationLineFloat, 1
EBLOCK
IEQ locationLine, L2
SET locationLineFloat, 2
EBLOCK
IEQ locationLine, L3
SET locationLineFloat, 3
EBLOCK
EACTION
EBEHAV

BEHAV OnVanBelongsToCompanySetup, msg_rcv, VanBelongsToCompany, Request
ACTION ConvertEnumToFloat, modify_self
IEQ companyEnum, C1
SET companyEnumFloat, 1
EBLOCK
IEQ companyEnum, C2
SET companyEnumFloat, 2
EBLOCK
IEQ companyEnum, C3
SET companyEnumFloat, 3
EBLOCK
IEQ companyEnum, C4
SET companyEnumFloat, 4
EBLOCK
IEQ companyEnum, C5
SET companyEnumFloat, 5
EBLOCK
EACTION
ACTION SendResponse, send_msg, VanBelongsToCompanyResponse, Request
IEQ RCV.companyEnum, companyEnumFloat
SET SEND.belongs, 1
ADDE companyList, RCV.sender
EBLOCK
INEQ RCV.companyEnum, companyEnumFloat
SET SEND.belongs, 0
EBLOCK
SEND RCV.sender
EACTION
EBEHAV

BEHAV OnLineBelongsToVanSetup, msg_rcv, LineBelongsToVan, Request
ACTION LineBelongsToVanAction, modify_self
ADDE linesList, RCV.sender
EACTION
EBEHAV

#-----------------------------------------------------------------------------------------------------
# BEHAV OnVanIsAvailable, msg_rcv, VanIsAvailable, Request
# ACTION VanIsAvailableAction, send_msg, VanIsAvailableResponse, Inform
# decl distanceFromDestination, float, 0
# ADD distanceFromDestination, RCV.destinationVertex
# SUBT distanceFromDestination, locationVertex
# SET SEND.available, 0
# ILTEQ distanceFromDestination, distanceThreshold
# SET distanceFromDestination, 0
# ADD distanceFromDestination, RCV.locationVertex
# SUBT distanceFromDestination, locationVertex
# ILTEQ distanceFromDestination, distanceThreshold
# SET SEND.available, 1
# EBLOCK
# EBLOCK
# SEND RCV.sender
# EACTION
# EBEHAV
#-----------------------------------------------------------------------------------------------------

BEHAV OnMoveVan, cyclic, MOVEINTERVAL
ACTION ChangeVanLocationVertex, modify_self
IEQ locationLineFloat, currentDestinationLineFloat
IGT currentDestinationVertex, locationVertex
ADD locationVertex, 1
EBLOCK
ILT currentDestinationVertex, locationVertex
SUBT locationVertex, 1
EBLOCK
IEQ locationVertex, currentDestinationVertex
SET askForIntersectionFlag, 1
DECL line, float, 0
DECL vertex, float, 0
LR line, listOfPassengersDestinationsLines, 0
LR vertex, listOfPassengersDestinationsVertices, 0
REME listOfPassengersDestinationsLines, line
REME listOfPassengersDestinationsVertices, vertex
LR line, listOfPassengersDestinationsLines, 0
LR vertex, listOfPassengersDestinationsVertices, 0
SET currentDestinationLineFloat, line
SET currentDestinationVertex, vertex
EBLOCK
EBLOCK
INEQ locationLineFloat, currentDestinationLineFloat
IGT intersectionVertex, locationVertex
ADD locationVertex, 1
EBLOCK
ILT intersectionVertex, locationVertex
SUBT locationVertex, 1
EBLOCK
IEQ locationVertex, intersectionVertex
SET locationLineFloat, afterIntersectionLineFloat
SET askForIntersectionFlag, 1
EBLOCK
EBLOCK
EACTION

ACTION MoveVanNewPassengerLocationAction, send_msg, MoveVanNewPassengerLocation, Inform
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND carriedPassengers
EACTION

ACTION AskForNewIntersectionAction, send_msg, RequestIntersectionPoint, Request
IEQ askForIntersectionFlag, 1
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SET SEND.destinationLineFloat, currentDestinationLineFloat
SEND linesList
EBLOCK
EACTION
EBEHAV

BEHAV OnPassengerAtDestination, msg_rcv, PassengerAtDestination, Inform
ACTION RemovePassengerAction, modify_self
DECL newScore, float, 0
REME carriedPassengers, RCV.sender
ADD sumOfTrips, 1
ADD sumOfScores, RCV.score
SET newScore, sumOfScores
DIV newScore, sumOfTrips
SET score, newScore 
# DECL line, float, 0
# DECL vertex, float, 0
# LR line, listOfPassengersDestinationsLines, 0
# LR vertex, listOfPassengersDestinationsVertices, 0
# REME listOfPassengersDestinationsLines, line
# REME listOfPassengersDestinationsVertices, vertex
# LR line, listOfPassengersDestinationsLines, 0
# LR vertex, listOfPassengersDestinationsVertices, 0
# SET currentDestinationLineFloat, line
# SET currentDestinationVertex, vertex
EACTION

# ACTION AskForNewIntersectionAction, send_msg, RequestIntersectionPoint, Request
# SET SEND.locationLineFloat, locationLineFloat
# SET SEND.locationVertex, locationVertex
# SET SEND.destinationLineFloat, currentDestinationLineFloat
# SEND linesList
# EACTION
EBEHAV

BEHAV OnSendIntersectionPoint, msg_rcv, SendIntersectionPoint, Inform
ACTION ModifyIntersectionPointsAction, modify_self
SET afterIntersectionLineFloat, RCV.line
SET intersectionVertex, RCV.vertex
EACTION
EBEHAV

BEHAV OnPassengerBookVan, msg_rcv, PassengerBookVan, Request
ACTION PassengerBookVanAction, send_msg, PassengerBookVanResponse, Inform
DECL listLength, float, 0
LEN listLength, carriedPassengers
DECL price, float, 0
DECL distance, float, 0
DECL travelTime, float, 0
RAND price, float, uniform, 20, 30
RAND distance, float, uniform, 20, 30
RAND travelTime, float, uniform, 20, 30
ILT listLength, maxPassengers
SET SEND.accepted, 1
SET SEND.price, price
SET SEND.distance, distance
SET SEND.travelTime, travelTime
SET SEND.score, score
SEND RCV.sender
EBLOCK
IEQ listLength, maxPassengers
SET SEND.accepted, 0
SET SEND.price, price
SET SEND.distance, distance
SET SEND.travelTime, travelTime
SET SEND.score, score
SEND RCV.sender
EBLOCK
EACTION
EBEHAV

BEHAV OnPassengerBookVanConfirmation, msg_rcv, SendConfirmationToVan, Inform
ACTION PassengerBookVanConfirmationAction, modify_self
ADDE carriedPassengers, RCV.sender
ADDE listOfPassengersDestinationsLines, RCV.locationLineFloat
ADDE listOfPassengersDestinationsVertices, RCV.locationVertex
ADDE listOfPassengersDestinationsLines, RCV.destinationLineFloat
ADDE listOfPassengersDestinationsVertices, RCV.destinationVertex
EACTION
EBEHAV

BEHAV CheckVanFull, cyclic, CYCLICCHECK
ACTION CheckVanFullAction, send_msg, VanFull, Inform
DECL listLength, float, 0
LEN listLength, carriedPassengers
IEQ listLength, maxPassengers
SEND companyList
EBLOCK
EACTION
ACTION CheckVanEmptyAction, send_msg, VanEmpty, Inform
DECL listLength, float, 0
LEN listLength, carriedPassengers
ILT listLength, maxPassengers
SEND companyList
EBLOCK
EACTION
EBEHAV
EAGENT


AGENT PassengerAgent
PRM locationLine, enum, L0, 25, L1, 25, L2, 25, L3, 25
PRM locationLineFloat, float, init, 0
PRM locationVertex, float, init, 0

PRM destinationLine, enum, L0, 25, L1, 25, L2, 25, L3, 25
PRM destinationLineFloat, float, init, 0
PRM destinationVertex, float, init, 0

PRM pricePreference, float, init, 0
PRM scorePreference, float, init, 0

PRM isTravelling, float, init, 0
PRM availableVan, list, conn

PRM refuseDecider, float, init, 0
PRM refusalCounter, float, init, 1
PRM acceptNewPassengerDecider, float, init, 0

BEHAV PassengerSetup, setup
ACTION GenerateVertexPosition, modify_self
RAND locationVertex, int, uniform, 0, LINELENGTH
RAND destinationVertex, int, uniform, 0, LINELENGTH
RAND pricePreference, float, uniform, 0, 1
RAND scorePreference, float, uniform, 1, 5
EACTION

ACTION ConvertEnumToFloat, modify_self
IEQ locationLine, L0
SET locationLineFloat, 0
EBLOCK
IEQ locationLine, L1
SET locationLineFloat, 1
EBLOCK
IEQ locationLine, L2
SET locationLineFloat, 2
EBLOCK
IEQ locationLine, L3
SET locationLineFloat, 3
EBLOCK

IEQ destinationLine, L0
SET destinationLineFloat, 0
EBLOCK
IEQ destinationLine, L1
SET destinationLineFloat, 1
EBLOCK
IEQ destinationLine, L2
SET destinationLineFloat, 2
EBLOCK
IEQ destinationLine, L3
SET destinationLineFloat, 3
EBLOCK
EACTION
EBEHAV

BEHAV SendMessageToAll, one_time, 2
ACTION SendMessageToAll, send_msg, PassengerRequest, Request
SET SEND.destinationLineFloat, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
EACTION
EBEHAV

BEHAV OnOfferFromCompanyReceive, msg_rcv, PassengerRequestResponse, Inform
ACTION SendMessageToVan, send_msg, PassengerBookVan, Request
IEQ RCV.accepted, 1
ADDE availableVan, RCV.vanId
SET SEND.destinationLineFloat, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND availableVan
EBLOCK
EACTION

ACTION SendMessageToAll, send_msg, PassengerRequest, Request
IEQ RCV.accepted, 0
SET SEND.destinationLineFloat, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
EBLOCK
EACTION
EBEHAV

BEHAV OnOfferFromVanReceive, msg_rcv, PassengerBookVanResponse, Inform

ACTION SendConfirmation, send_msg, SendConfirmationToVan, Inform
SET SEND.destinationLineFloat, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
DECL acceptFlag, float, 0
DECL pricePerVertex, float, 0
IEQ RCV.accepted, 1
SET pricePerVertex, RCV.price
DIV pricePerVertex, RCV.distance
IGTEQ RCV.score, scorePreference
SET acceptFlag, 1
EBLOCK
ILTEQ pricePerVertex, pricePreference
SET acceptFlag, 1
EBLOCK
IEQ acceptFlag, 1
SET isTravelling, 1
SEND RCV.sender
EBLOCK
EBLOCK
EACTION

ACTION SendRefusal, send_msg, SendRefusalToVan, Inform
DECL refuseFlag, float, 0
DECL pricePerVertex, float, 0
IEQ RCV.accepted, 1
SET pricePerVertex, RCV.price
DIV pricePerVertex, RCV.distance
ILT RCV.score, scorePreference
SET refuseFlag, 1
EBLOCK
IGT pricePerVertex, pricePreference
SET refuseFlag, 1
EBLOCK
IEQ refuseFlag, 1
SET refuseDecider, 1
SEND RCV.sender
EBLOCK
EBLOCK
EACTION

ACTION SendMessageToAll, send_msg, PassengerRequest, Request
IEQ RCV.accepted, 0
SET SEND.destinationLineFloat, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
EBLOCK
IEQ refuseDecider, 1
ILTEQ refusalCounter, 5
SET SEND.destinationLineFloat, destinationLineFloat
SET SEND.destinationVertex, destinationVertex
SET SEND.locationLineFloat, locationLineFloat
SET SEND.locationVertex, locationVertex
SEND connections
ADD refusalCounter, 1
EBLOCK
EBLOCK
EACTION
EBEHAV

BEHAV OnMoveVanNewPassengerLocation, msg_rcv, MoveVanNewPassengerLocation, Inform
ACTION ChangeLocation, modify_self
IEQ isTravelling, 1
SET locationLineFloat, RCV.locationLineFloat
SET locationVertex, RCV.locationVertex
EBLOCK
EACTION

ACTION CheckIfAtDestination, send_msg, PassengerAtDestination, Inform
IEQ isTravelling, 1
IEQ locationLineFloat, destinationLineFloat
IEQ locationVertex, destinationVertex
# SET SEND.atDestination, 0
SET SEND.score, 0
# SET SEND.pricePaid, 0
## TODO: Increase price per move, VanAgent needs to send to PassengerAgent price per move, then it needs to be stored in PassengerAgent and added here
SEND RCV.sender
EBLOCK
EBLOCK
EBLOCK
EACTION
EBEHAV

BEHAV OnAcceptNewPassenger, msg_rcv, AcceptNewPassenger, Request
ACTION SendConfirmation, send_msg, SendConfirmationToVanAboutNewPassenger, Inform
RAND acceptNewPassengerDecider, float, uniform, 0, 1
ILTEQ acceptNewPassengerDecider, ACCEPTNEWPASSENGERTHRESHOLD
SEND RCV.sender
EBLOCK
# DECL decider, float, 0
# SET decider, RCV.additionalTime
# DIV decider, RCV.reducedPrice
# ILTEQ decider, 1 #TODO: maybe we can randomize it in the future
# SEND RCV.sender
# EBLOCK
EACTION

ACTION SendRefusal, send_msg, SendRefusalToVanAboutNewPassenger, Inform
# DECL decider, float, 0
# SET decider, RCV.additionalTime
# DIV decider, RCV.reducedPrice
# IGT decider, 1 #TODO: maybe we can randomize it in the future
# SEND RCV.sender
# EBLOCK
IGT acceptNewPassengerDecider, ACCEPTNEWPASSENGERTHRESHOLD
SEND RCV.sender
EBLOCK
EACTION
EBEHAV
EAGENT




